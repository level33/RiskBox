<!DOCTYPE html>
<html>
	<head>
		<title>RiskBox Excel Preprocessor</title>
		<link rel="icon" href="/favicon.ico" type="image/x-icon" />
    	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<script type="text/javascript" src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

		<script type="text/javascript">
		
		function showMessage(text){
			document.getElementById("file_msg").innerHTML = text;
		}
		
		//Send input data to RiskBox
		function doInput() {
		  	var xhttp = new XMLHttpRequest();
			var inputData = {account_name:"fed", payload: result};
			xhttp.onreadystatechange = function() {
			   if (this.readyState == 4) {
			     console.log(JSON.parse(this.responseText));
			     showMessage("INPUT data sent successfuly! Send the algorithm now.");
			   }
			};
			xhttp.open("POST", "/input");
			xhttp.setRequestHeader("Content-Type", "application/json");
			xhttp.send(JSON.stringify(inputData));
		}	
		
		//Send compute command to RiskBox
		function doRiskBox(){
			var xhttp = new XMLHttpRequest();
			var inputData = {account_name:"fed", payload: result};
			xhttp.onreadystatechange = function() {
			   if (this.readyState == 4) {
			     console.log(JSON.parse(this.responseText));
			     showMessage("INPUT data sent successfuly! Algorithm finished! All done!");
			   }
			};
			xhttp.open("POST", "/compute");
			xhttp.setRequestHeader("Content-Type", "text/plain");
			xhttp.setRequestHeader("cache-control", "no-cache");
			xhttp.send(document.getElementById("algorithm").value);
			
		}

		//function json array to excel row
		function a2r(arr){
			var result = {};
			var header = ["A", "B", "C", "D", "E", "F", "G", "H", "I",
			              "J", "K", "L", "M", "N", "O", "P", "Q", "R",
						   "S", "T", "U", "V", "W", "X", "Y", "Z"];
			
			for (var i = 0; i< arr.length; i++){
				result[header[i]] = arr[i];	
			}
			var tresult = [];
			tresult.push(result);
			return tresult;
		}
				
		//json array to excel column
		function a2c(arr){
			var result = [];
			
			for(var i = 0; i<arr.length; i++){
				result.push({A: arr[i]});
			}
			
			return result;
		}
		
		//Get results from RiskBox and download them as Excel file
		function getResults(){
			var workbook = XLSX.utils.book_new();
			if(!workbook.Props) workbook.Props = {};
			workbook.Props.Title = "RiskBox Demo";
			workbook.Props.Company = "Level 33";
			
			var ws = XLSX.utils.json_to_sheet([{A:"Inherent Risk"}], {header:["A"], skipHeader:true});
			XLSX.utils.sheet_add_json(ws,[{A:"Products"}], {skipHeader: true, origin: "A2"});
			XLSX.utils.sheet_add_json(ws,a2r(__output["data"]["risktypes"]), {skipHeader: true, origin: "B2"});
			XLSX.utils.sheet_add_json(ws,a2c(__output["data"]["products"]), {skipHeader: true, origin: "A3"});
			var r = 3;
			__output["data"]["products"].forEach(function(prd){
				XLSX.utils.sheet_add_json(ws,a2r(__output["result"]["IR"][prd]["IR"]), {skipHeader: true, origin: "B"+r});
				r++;
			})

			XLSX.utils.book_append_sheet(workbook, ws, "Inherent Risk Summary");
			
			ws = XLSX.utils.json_to_sheet([{A:"Product Summary"}], {header:["A"], skipHeader:true});
			XLSX.utils.sheet_add_json(ws,[{A:"Products", B:"Inherent Risk", C:"Risk Mitigation Index", D: "Residual Risk"}], {skipHeader: true, origin: "A2"});
			
			var sh = [];
			var h = __output["data"]["riskcomponents"]["layout"].reduce(function(accumulator, currentValue, currentIndex, array){
				accumulator = accumulator.concat(__output["data"]["riskcomponents"][currentValue].map(function(val){return [val+"_ASA", val+"_MSA"]})).flat();
				sh = sh.concat(__output["data"]["riskcomponents"][currentValue]);
				return accumulator;
			},["TOTAL_ASA", "TOTAL_MSA"]);
			
			XLSX.utils.sheet_add_json(ws,a2r(h), {skipHeader: true, origin: "E2"});
			XLSX.utils.sheet_add_json(ws,a2c(__output["data"]["products"]), {skipHeader: true, origin: "A3"});
			var r = 3;
			__output["data"]["products"].forEach(function(prd){
				var tmp = [];
				tmp.push(__output["result"]["PS"][prd]["IR"]);
				tmp.push(__output["result"]["PS"][prd]["RMI"]);
				tmp.push(__output["result"]["PS"][prd]["RR"]);
				tmp.push(__output["result"]["PS"][prd]["TOTAL_ASA"]);
				tmp.push(__output["result"]["PS"][prd]["TOTAL_MSA"]);
				sh.forEach(function(elm){
					if(typeof __output["result"]["PS"][prd][elm] === 'undefined'){
						tmp.push(0); tmp.push(0);
					} else{
						tmp.push(__output["result"]["PS"][prd][elm]["ASA"]);
						tmp.push(__output["result"]["PS"][prd][elm]["MSA"]);	
					}				
				})
				XLSX.utils.sheet_add_json(ws,a2r(tmp), {skipHeader: true, origin: "B"+r});
				r++;
			})

			XLSX.utils.book_append_sheet(workbook, ws, "Product Summary");
			
			
			
			XLSX.writeFile(workbook, 'out.xlsx');	
		}
		
		
		//Do local JS computation
		function sandbox(){
			var __input = result;
			
			//test the algorithm here before sending it to RiskBox
			
			// >>> SOA >>>
			
			//Array sum function
			function arraySUM(accumulator, currentValue, currentIndex, array) {
				return accumulator + currentValue;
			}
			//Setup layout
			var assembly = {PS:{}, IR:{}};
			//Product Summary
			//Compute Inherent Risk - IR
			__input["euf"].forEach(function(element){
				var tmpIR = element.riskmatrix.values.map(function(val) {
				  return val * element.vbw;
				});
				var ceuf = element.riskmatrix.values.reduce(arraySUM,0);
				var totalIR = tmpIR.reduce(arraySUM, 0);
				assembly.IR[element.product]= {vbw: element.vbw, risk: element.riskmatrix.risk, values: element.riskmatrix.values, 
				           ceuf: ceuf, totalIR: totalIR, IR: tmpIR};
				assembly.PS[element.product] = {IR: totalIR, RMI:0, RR:0, TOTAL_ASA:0, TOTAL_MSA:0};				
			});

			//Compute RMI, RR, ASA, MSA for detailed forms
			//transactionprocessing, referencedatamanagement, coresystemsmanagement
			var tp = {IR:[], MSA:[], ASA:[], RMI:[], RR:[], col_values:{ASA:[], MSA:[], RMI:[]}}, 
			    rdm = {IR:[], MSA:[], ASA:[], RMI:[], RR:[], col_values:{ASA:[], MSA:[], RMI:[]}},
				csm = {IR:[], MSA:[], ASA:[], RMI:[], RR:[], col_values:{ASA:[], MSA:[], RMI:[]}};

			//Get IR for each product, compute MAS, ASA, RMI, and RR
			var sumbpc = __input["transactionprocessing"]["values"].reduce(arraySUM, 0);
			__input["transactionprocessing"]["layout"].forEach(function(element, idx){
				//For all those 3 subrisks use Processing IR
				var _ir = assembly.IR[element]["IR"][assembly.IR[element]["risk"].indexOf("Processing")];
				var _msa = 0, _asa = 0;
				//Compute the aggregated sum for each bc >> asa, if asa > 0 then compute msa
				__input["transactionprocessing"][element]["bc_values"].forEach(function(bcv){
					var partial_sp = bcv.reduce(function(accumulator, currentValue, currentIndex, array){
						return accumulator + currentValue*__input["transactionprocessing"]["values"][currentIndex];
					},0);
					_asa += partial_sp;
					if(partial_sp != 0){
						_msa += _ir*sumbpc*100.0;
					}
				});
				_asa *= _ir;
				var _rmi = 100.0*_asa/_msa;
				var _rr = (100.0 - _rmi)/100.0*_ir;
				tp.IR.push(_ir);
				tp.MSA.push(_msa);
				tp.ASA.push(_asa);
				tp.RMI.push(_rmi);
				tp.RR.push(_rr);
				assembly.PS[element]["Transaction Processing"] = {MSA: _msa, ASA: _asa};	
				assembly.PS[element]["TOTAL_ASA"]+=_asa;
				assembly.PS[element]["TOTAL_MSA"]+=_msa;	
			});
			//For each bpc compute MSA, ASA, and RMI
			//TODO


			//Get IR for each product, compute MAS, ASA, RMI, and RR
			var sumbpc = __input["referencedatamanagement"]["values"].reduce(arraySUM, 0);
			__input["referencedatamanagement"]["layout"].forEach(function(element, idx){
				//For all those 3 subrisks use Processing IR
				var _ir = assembly.IR[element]["IR"][assembly.IR[element]["risk"].indexOf("Processing")];
				var _msa = 0, _asa = 0;
				//Compute the aggregated sum for each bc >> asa, if asa > 0 then compute msa
				__input["referencedatamanagement"][element]["bc_values"].forEach(function(bcv){
					var partial_sp = bcv.reduce(function(accumulator, currentValue, currentIndex, array){
						return accumulator + currentValue*__input["referencedatamanagement"]["values"][currentIndex];
					},0);
					_asa += partial_sp;
					if(partial_sp != 0){
						_msa += _ir*sumbpc*100.0;
					}
				});
				_asa *= _ir;
				var _rmi = 100.0*_asa/_msa;
				var _rr = (100.0 - _rmi)/100.0*_ir;
				rdm.IR.push(_ir);
				rdm.MSA.push(_msa);
				rdm.ASA.push(_asa);
				rdm.RMI.push(_rmi);
				rdm.RR.push(_rr);
				assembly.PS[element]["Reference Data Management"] = {MSA: _msa, ASA: _asa};	
				assembly.PS[element]["TOTAL_ASA"]+=_asa;
				assembly.PS[element]["TOTAL_MSA"]+=_msa;	
			});
			//For each bpc compute MSA, ASA, and RMI
			//TODO


			//Get IR for each product, compute MAS, ASA, RMI, and RR
			var sumbpc = __input["coresystemsmanagement"]["values"].reduce(arraySUM, 0);
			__input["coresystemsmanagement"]["layout"].forEach(function(element, idx){
				//For all those 3 subrisks use Processing IR
				var _ir = assembly.IR[element]["IR"][assembly.IR[element]["risk"].indexOf("Processing")];
				var _msa = 0, _asa = 0;
				//Compute the aggregated sum for each bc >> asa, if asa > 0 then compute msa
				__input["coresystemsmanagement"][element]["bc_values"].forEach(function(bcv){
					var partial_sp = bcv.reduce(function(accumulator, currentValue, currentIndex, array){
						return accumulator + currentValue*__input["coresystemsmanagement"]["values"][currentIndex];
					},0);
					_asa += partial_sp;
					if(partial_sp != 0){
						_msa += _ir*sumbpc*100.0;
					}
				});
				_asa *= _ir;
				var _rmi = 100.0*_asa/_msa;
				var _rr = (100.0 - _rmi)/100.0*_ir;
				csm.IR.push(_ir);
				csm.MSA.push(_msa);
				csm.ASA.push(_asa);
				csm.RMI.push(_rmi);
				csm.RR.push(_rr);
				assembly.PS[element]["Core Systems Management"] = {MSA: _msa, ASA: _asa};	
				assembly.PS[element]["TOTAL_ASA"]+=_asa;
				assembly.PS[element]["TOTAL_MSA"]+=_msa;	
			});
			//For each bpc compute MSA, ASA, and RMI
			//TODO


			assembly.tp = tp;
			assembly.rdm = rdm;
			assembly.csm = csm;
			
			//Compute RMI, RR, ASA, MSA for direct forms
			//tradingmanagement, creditmanagement, liquiditymanagement, interestratemanagement, salesmanagement
			var tm = {IR:[], MSA:[], ASA:[], RMI:[], RR:[], col_values:{ASA:[], MSA:[], RMI:[]}}, 
			    cm = {IR:[], MSA:[], ASA:[], RMI:[], RR:[], col_values:{ASA:[], MSA:[], RMI:[]}}, 
			    lm = {IR:[], MSA:[], ASA:[], RMI:[], RR:[], col_values:{ASA:[], MSA:[], RMI:[]}}, 
				irm = {IR:[], MSA:[], ASA:[], RMI:[], RR:[], col_values:{ASA:[], MSA:[], RMI:[]}}, 
				sm = {IR:[], MSA:[], ASA:[], RMI:[], RR:[], col_values:{ASA:[], MSA:[], RMI:[]}} ;
			
			//Get IR for each product, compute MAS, ASA, RMI and RR
			var sumbpc = __input["tradingmanagement"]["values"].reduce(arraySUM, 0);
			__input["tradingmanagement"]["layout"].forEach(function(element, idx){
				var _ir = assembly.IR[element]["IR"][assembly.IR[element]["risk"].indexOf("Trading")];
				var _msa = _ir*sumbpc*100;
				var _asa = __input["tradingmanagement"]["values"].reduce(function(accumulator, currentValue, currentIndex, array) {
				  return accumulator + currentValue*__input["tradingmanagement"]["prod_values"][idx][currentIndex];
				},0);
				_asa*=_ir;
				var _rmi = 100.0*_asa/_msa;
				var _rr = (100.0-_rmi)/100.0*_ir;
				tm.IR.push(_ir);
				tm.MSA.push(_msa);
				tm.ASA.push(_asa);
				tm.RMI.push(_rmi);
				tm.RR.push(_rr);
				assembly.PS[element]["Trading Management"] = {MSA: _msa, ASA: _asa};	
				assembly.PS[element]["TOTAL_ASA"]+=_asa;
				assembly.PS[element]["TOTAL_MSA"]+=_msa;						
			});
			//For each BPC compute MSA, ASA and RMI
			var sumir = tm.IR.reduce(arraySUM, 0);
			__input["tradingmanagement"]["values"].forEach(function(element, idx){
				var _msa = element*sumir*100;
				var _asa = 0;
				__input["tradingmanagement"]["prod_values"].forEach(function(elm,id){
					_asa+= elm[idx]*tm.IR[id];
				});
				_asa*=element;
				var _rmi = 100.0*_asa/_msa;
				tm.col_values.MSA.push(_msa);
				tm.col_values.ASA.push(_asa);
				tm.col_values.RMI.push(_rmi);
			});
						
			//Get IR for each product, compute MAS, ASA, RMI and RR
			sumbpc = __input["creditmanagement"]["values"].reduce(arraySUM, 0);
			__input["creditmanagement"]["layout"].forEach(function(element, idx){
				var _ir = assembly.IR[element]["IR"][assembly.IR[element]["risk"].indexOf("Lending")];
				var _msa = _ir*sumbpc*100;
				var _asa = __input["creditmanagement"]["values"].reduce(function(accumulator, currentValue, currentIndex, array) {
				  return accumulator + currentValue*__input["creditmanagement"]["prod_values"][idx][currentIndex];
				},0);
				_asa*=_ir;
				var _rmi = 100.0*_asa/_msa;
				var _rr = (100.0-_rmi)/100.0*_ir;
				cm.IR.push(_ir);
				cm.MSA.push(_msa);
				cm.ASA.push(_asa);
				cm.RMI.push(_rmi);
				cm.RR.push(_rr);
				assembly.PS[element]["Credit Management"] = {MSA: _msa, ASA: _asa};
				assembly.PS[element]["TOTAL_ASA"]+=_asa;
				assembly.PS[element]["TOTAL_MSA"]+=_msa;								
			});
			//For each BPC compute MSA, ASA and RMI
			sumir = cm.IR.reduce(arraySUM, 0);
			__input["creditmanagement"]["values"].forEach(function(element, idx){
				var _msa = element*sumir*100;
				var _asa = 0;
				__input["creditmanagement"]["prod_values"].forEach(function(elm,id){
					_asa+= elm[idx]*cm.IR[id];
				});
				_asa*=element;
				var _rmi = 100.0*_asa/_msa;
				cm.col_values.MSA.push(_msa);
				cm.col_values.ASA.push(_asa);
				cm.col_values.RMI.push(_rmi);
			});					
			
			//Get IR for each product, compute MAS, ASA, RMI and RR
			sumbpc = __input["liquiditymanagement"]["values"].reduce(arraySUM, 0);
			__input["liquiditymanagement"]["layout"].forEach(function(element, idx){
				var _ir = assembly.IR[element]["IR"][assembly.IR[element]["risk"].indexOf("Funding")];
				var _msa = _ir*sumbpc*100;
				var _asa = __input["liquiditymanagement"]["values"].reduce(function(accumulator, currentValue, currentIndex, array) {
				  return accumulator + currentValue*__input["liquiditymanagement"]["prod_values"][idx][currentIndex];
				},0);
				_asa*=_ir;
				var _rmi = 100.0*_asa/_msa;
				var _rr = (100.0-_rmi)/100.0*_ir;
				lm.IR.push(_ir);
				lm.MSA.push(_msa);
				lm.ASA.push(_asa);
				lm.RMI.push(_rmi);
				lm.RR.push(_rr);
				assembly.PS[element]["Liquidity Management"] = {MSA: _msa, ASA: _asa};
				assembly.PS[element]["TOTAL_ASA"]+=_asa;
				assembly.PS[element]["TOTAL_MSA"]+=_msa;								
			});
			//For each BPC compute MSA, ASA and RMI
			sumir = lm.IR.reduce(arraySUM, 0);
			__input["liquiditymanagement"]["values"].forEach(function(element, idx){
				var _msa = element*sumir*100;
				var _asa = 0;
				__input["liquiditymanagement"]["prod_values"].forEach(function(elm,id){
					_asa+= elm[idx]*lm.IR[id];
				});
				_asa*=element;
				var _rmi = 100.0*_asa/_msa;
				lm.col_values.MSA.push(_msa);
				lm.col_values.ASA.push(_asa);
				lm.col_values.RMI.push(_rmi);
			});			
			
			//Get IR for each product, compute MAS, ASA, RMI and RR
			sumbpc = __input["interestratemanagement"]["values"].reduce(arraySUM, 0);
			__input["interestratemanagement"]["layout"].forEach(function(element, idx){
				var _ir = assembly.IR[element]["IR"][assembly.IR[element]["risk"].indexOf("Interest")];
				var _msa = _ir*sumbpc*100;
				var _asa = __input["interestratemanagement"]["values"].reduce(function(accumulator, currentValue, currentIndex, array) {
				  return accumulator + currentValue*__input["interestratemanagement"]["prod_values"][idx][currentIndex];
				},0);
				_asa*=_ir;
				var _rmi = 100.0*_asa/_msa;
				var _rr = (100.0-_rmi)/100.0*_ir;
				irm.IR.push(_ir);
				irm.MSA.push(_msa);
				irm.ASA.push(_asa);
				irm.RMI.push(_rmi);
				irm.RR.push(_rr);
				assembly.PS[element]["Interest Rate Management"] = {MSA: _msa, ASA: _asa};
				assembly.PS[element]["TOTAL_ASA"]+=_asa;
				assembly.PS[element]["TOTAL_MSA"]+=_msa;								
			});
			//For each BPC compute MSA, ASA and RMI
			sumir = irm.IR.reduce(arraySUM, 0);
			__input["interestratemanagement"]["values"].forEach(function(element, idx){
				var _msa = element*sumir*100;
				var _asa = 0;
				__input["interestratemanagement"]["prod_values"].forEach(function(elm,id){
					_asa+= elm[idx]*irm.IR[id];
				});
				_asa*=element;
				var _rmi = 100.0*_asa/_msa;
				irm.col_values.MSA.push(_msa);
				irm.col_values.ASA.push(_asa);
				irm.col_values.RMI.push(_rmi);
			});	
							
			//Get IR for each product, compute MAS, ASA, RMI and RR
			sumbpc = __input["salesmanagement"]["values"].reduce(arraySUM, 0);
			__input["salesmanagement"]["layout"].forEach(function(element, idx){
				var _ir = assembly.IR[element]["IR"][assembly.IR[element]["risk"].indexOf("Selling")];
				var _msa = _ir*sumbpc*100;
				var _asa = __input["salesmanagement"]["values"].reduce(function(accumulator, currentValue, currentIndex, array) {
				  return accumulator + currentValue*__input["salesmanagement"]["prod_values"][idx][currentIndex];
				},0);
				_asa*=_ir;
				var _rmi = 100.0*_asa/_msa;
				var _rr = (100.0-_rmi)/100.0*_ir;
				sm.IR.push(_ir);
				sm.MSA.push(_msa);
				sm.ASA.push(_asa);
				sm.RMI.push(_rmi);
				sm.RR.push(_rr);
				assembly.PS[element]["Sales Management"] = {MSA: _msa, ASA: _asa};
				assembly.PS[element]["TOTAL_ASA"]+=_asa;
				assembly.PS[element]["TOTAL_MSA"]+=_msa;								
			});
			//For each BPC compute MSA, ASA and RMI
			sumir = sm.IR.reduce(arraySUM, 0);
			__input["salesmanagement"]["values"].forEach(function(element, idx){
				var _msa = element*sumir*100;
				var _asa = 0;
				__input["salesmanagement"]["prod_values"].forEach(function(elm,id){
					_asa+= elm[idx]*sm.IR[id];
				});
				_asa*=element;
				var _rmi = 100.0*_asa/_msa;
				sm.col_values.MSA.push(_msa);
				sm.col_values.ASA.push(_asa);
				sm.col_values.RMI.push(_rmi);
			});							
			
			assembly.tm = tm;
			assembly.cm = cm;
			assembly.lm = lm;
			assembly.irm = irm;
			assembly.sm = sm;
			
			//compute RMI si RR for PS
			__input["products"].forEach(function(element){
				assembly.PS[element]["RMI"]=100.0*assembly.PS[element]["TOTAL_ASA"]/assembly.PS[element]["TOTAL_MSA"];
				assembly.PS[element]["RR"]=(100.0-assembly.PS[element]["RMI"])/100.0*assembly.PS[element]["IR"];
			});
			
			__output = { data: __input, result: assembly};
				
			// .: EOA :.
				
			console.log(__output);
		}
		
		//Parse EUF worksheet
		function parseEUF(ws){
			//the result will be an array of objects
			var parseResult = [];
			//console.log("Products: " + result.products.length + " | Risk Types: " + result.risktypes.length);
			//this block repreats k = size of products
			var DONE = false;
			var block = 1;
			var productCount = 0;
			
			while(!DONE){
			var tmp = {};
				//A1 B1 contains the property name
				//A2 B2 the values
				block++;
				tmp.product = ws['A'+block].v;
				tmp.vbw = ws['B'+block].v;
				block+=2;
				//C3 D3 property name
				//C4 ... Cn D4 ... D4 array of values, where n = size of risktypes
				tmp.riskmatrix = {risk:[], values: []};
					for(var i = 0; i< result.risktypes.length; i++){
						tmp.riskmatrix.risk.push(ws['C'+block].v);
						tmp.riskmatrix.values.push(ws['D'+block].v);
						block++;
					}
				parseResult.push(tmp);
				productCount++;
				DONE = productCount>=result.products.length;
			}
			return parseResult;
		}
		
		//Parse riskcomponents spreadsheet
		function parseRC(ws){
			var parseResult = {layout:[]};
			//variable structure property : array of strings
			//column A - risk
			//column B - component
			var row = 2;
			var risk="";

			do{
				if (ws['A'+row]){
					risk=ws['A'+row].v;
					parseResult[risk]=[];
					parseResult.layout.push(risk);
					
				}
				parseResult[risk].push(ws['B'+row].v);
				row++;
			}while(ws['B'+row])
			return parseResult;
		}
		
		//Parse bestpracticecategories spreadsheet
		function parseBPC(ws){
			var parseResult = {layout:[]};
			//variable structure property : object{ property : array of strings}
			//column A - category
			//column B - subcategory
			//column C - item
			
			var row = 2;
			var category = "", subcategory = "";
			do{
				if(ws['A'+row]){
					category = ws['A'+row].v;
					parseResult[category]={layout:[]};
					parseResult.layout.push(category);
				}
				if(ws['B'+row]){
					subcategory = ws['B'+row].v;
					parseResult[category][subcategory]= [];
					parseResult[category].layout.push(subcategory);	
				}
				parseResult[category][subcategory].push(ws['C'+row].v);
				row++;
			}while(ws['C'+row]);
			
			
			return parseResult;	
		}
		
		//Parse Processing Risk spreadsheets
		function parsePR(ws){
			var cols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
			var parseResult = {layout:[], bpc:[], values:[], bc:[]};
			var lastRow = ws['!ref'].split(":")[1].substr(1);
			var lastColumn = ws['!ref'].split(":")[1].substr(0,1);
			var block = (lastRow-3)/result.products.length;
			
			
			for(var i=0; i<result.products.length; i++){
				//A_block+1 product
				//A_block+3 ... A_[2*block-1] bc
				//B_block+3 ... lastColumn_[2*block-1] bc_values
				//B_lastRow-1 ... lastColumn_lastRow-1 bpc
				//B_lastRow ... lastColumn_lastRow values

				var row = i*block;
				row+=2;
				var prod = ws['A'+row].v;
				parseResult["layout"].push(prod);
				parseResult[prod] = {bc_values:[]};
				row+=2;
				for(var k=row; k<row+block-3; k++){
					parseResult[prod]["bc_values"].push([]);
					var s = cols.indexOf('B');
					while(lastColumn != cols.charAt(s)){
						parseResult[prod]["bc_values"][k-row].push(ws[cols.charAt(s)+k].v);
						s++;
					}
					parseResult[prod]["bc_values"][k-row].push(ws[lastColumn+k].v);
				}
			}
			//Read bc once
			for(var j=4; j<=block; j++){
				parseResult["bc"].push(ws['A'+j].v);
			};
			//Read bpc on the last 2 rows
			var start = cols.indexOf('B');
			while(lastColumn != cols.charAt(start)){
				parseResult["bpc"].push(ws[cols.charAt(start)+(lastRow-1)].v);
				parseResult["values"].push(ws[cols.charAt(start)+lastRow].v);
				start++;					
			};
			parseResult["bpc"].push(ws[lastColumn+(lastRow-1)].v);
			parseResult["values"].push(ws[lastColumn+lastRow].v);
			
			return parseResult;
		}
			
		//Parse product risk spreadsheets
		function parseProdRisk(ws){
			var cols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
			var parseResult = {layout:[], bpc:[], values: [], prod_values: []};
			var lastRow = ws['!ref'].split(":")[1].substr(1);
			var lastColumn = ws['!ref'].split(":")[1].substr(0,1);
			//A2 ... lastRow-3 - product
			//B2 ... lastColumn prod_values
			//B_lastRow-1 ... lastColumn_lastRow-1 bpc
			//B_lastRow ... lastColumn_lastRow values 
			
			for(var i=2; i<lastRow-2; i++){
				parseResult["layout"].push(ws['A'+i].w);
				parseResult["prod_values"].push([]);
				var s = cols.indexOf('B');
				while(lastColumn != cols.charAt(s)){
					parseResult["prod_values"][i-2].push(ws[cols.charAt(s)+i].v);
					s++;
				}
				parseResult["prod_values"][i-2].push(ws[lastColumn+i].v);
			}
			
			var start = cols.indexOf('B');
			while(lastColumn != cols.charAt(start)){
				parseResult["bpc"].push(ws[cols.charAt(start)+(lastRow-1)].v);
				parseResult["values"].push(ws[cols.charAt(start)+lastRow].v);
				start++;
			}
			parseResult["bpc"].push(ws[lastColumn+(lastRow-1)].v);
			parseResult["values"].push(ws[lastColumn+lastRow].v);			
			return parseResult;
		}
		
		var rABS = true; // true: readAsBinaryString ; false: readAsArrayBuffer
		var workbook;
		var result = {}; //the input data will be stored here --- send to server
		var algorithm = ""; //the algorithm will be stored here --- send to server

		function handleFile(e) {
		  var files = e.target.files, f = files[0];
		  var reader = new FileReader();
		  reader.onload = function(e) {
		    var data = e.target.result;
		    if(!rABS) data = new Uint8Array(data);
		    workbook = XLSX.read(data, {type: rABS ? 'binary' : 'array'});
		
		    /* DO SOMETHING WITH workbook HERE */
			//output the sheet names to console
			console.log("Processing ...");

			workbook.SheetNames.forEach(function(element){
				//console.log(element);
				var processedWS = workbook.Sheets[element];
				switch(element){
					case "products":
						result.products = XLSX.utils.sheet_to_json(processedWS,{header:1}).flat();
					break;
					case "risktypes":
						result.risktypes = XLSX.utils.sheet_to_json(processedWS,{header:1}).flat();
					break;
					case "euf":
						result.euf = parseEUF(processedWS);
					break;
					case "riskcomponents":
						result.riskcomponents = parseRC(processedWS);
					break;
					case "bestpracticecategories":
						result.bpc = parseBPC(processedWS);
					break;
					case "comp_pr_transactionprocessing":
						result.transactionprocessing = parsePR(processedWS); 
					break;
					case "comp_pr_referencedatamanagement":
						result.referencedatamanagement = parsePR(processedWS); 
					break;
					case "comp_pr_coresystemsmanagement":
						result.coresystemsmanagement = parsePR(processedWS); 
					break;
					case "comp_tradingmanagement":
						result["tradingmanagement"] = parseProdRisk(processedWS);
					break;
					case "comp_creditmanagement":
						result["creditmanagement"] = parseProdRisk(processedWS);
					break;
					case "comp_liquiditymanagement":
						result["liquiditymanagement"] = parseProdRisk(processedWS);
					break;
					case "comp_interestratemanagement":
						result["interestratemanagement"] = parseProdRisk(processedWS);
					break;
					case "comp_salesmanagement":
						result["salesmanagement"] = parseProdRisk(processedWS);
					break;																			
					default:
						console.log(element + " unknown speradsheet. Igonred!")
				}
                   //var roa = XLSX.utils.sheet_to_json(workbook.Sheets[element]);
                   //if (roa.length) result[element] = roa;
               });
			console.log(result);
			showMessage("DONE! Proceed to step 2 >>>");
			
               //console.log(JSON.stringify(result, 2, 2));
		  };
		  if(rABS) reader.readAsBinaryString(f); else reader.readAsArrayBuffer(f);
		};
		
		window.onload = function(){	
			var _file = document.getElementById('file');				
			_file.addEventListener('change', handleFile, false); 
		}
		</script>		
		
    </head>
	<body>
			<div id="file_msg">load file and wait for DONE message in this box!</div>
		<hr/>
		
		<h1>Step 1. Select and upload the Excel file containing input data according to template format</h1>
		<input type="file" id="file" name="file" value=""/>
		<label for="file">... or click here to select the Excel file</label>
		
		<hr/>
		<h1>Step 2. Check the algorithm/method and click the button bellow</h1>
		<textarea rows="10" cols="128" id="algorithm"></textarea>
		<br/>
		<input type="button" onclick="doInput()" value="Send INPUT data"/>
		<input type="button" onclick="doRiskBox()" value="Send Algorithm to RiskBox and Compute"/>

		<br/><input type="button" onclick="sandbox()" value="test in browser"/>

		
		<hr/>
		<h1>Step 3. Download Excel file with results</h1>
		<input type="button" onclick="getResults()" value="Click to download"/>

	</body>
</html>